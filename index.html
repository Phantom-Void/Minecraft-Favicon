<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Voxel — Fixed Camera (Fast)</title>
<style>
  :root { --bg:#071018; --muted:#9fb7c9 }
  html,body { height:100%; margin:0; background:var(--bg); color:#eee; font-family:sans-serif; overflow:hidden }
  #fps { position:fixed; left:10px; top:10px; color:#9fb7c9; font-size:14px; font-family:monospace }
</style>
</head>
<body>
<div id="fps"></div>
<canvas id="game"></canvas>
<script>
// -------------------------------------------
// ORIGINAL CONSTANTS
// -------------------------------------------
const canvas = document.getElementById("game");
const gl = canvas.getContext("webgl2");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Camera
let camX = 0, camY = 10, camZ = 0;
let velX = 0, velY = 0, velZ = 0;
let yaw = 0, pitch = 0;

// Movement keys
let keys = {};
document.addEventListener("keydown", e => keys[e.code] = true);
document.addEventListener("keyup", e => keys[e.code] = false);

// Mouse
document.body.addEventListener("click", () => canvas.requestPointerLock());
document.addEventListener("mousemove", e => {
  if (document.pointerLockElement === canvas) {
    yaw   -= e.movementX * 0.002;
    pitch -= e.movementY * 0.002;

    pitch = Math.max(-1.55, Math.min(1.55, pitch));
  }
});

// -------------------------------------------
// WORLD (original code unchanged)
// -------------------------------------------
function isBlock(x, y, z) {
  return y < 0; // flat ground
}

// -------------------------------------------
// FIXED COLLISION FUNCTION (clean patch)
// -------------------------------------------
function collideAndSlide(px, py, pz, vx, vy, vz) {
  // Save original
  let nextX = px + vx;
  let nextY = py + vy;
  let nextZ = pz + vz;

  // --- X collision ---
  if (isBlock(Math.floor(nextX), Math.floor(py), Math.floor(pz))) {
    nextX = px; // undo movement
    vx = 0;
  }

  // --- Z collision ---
  if (isBlock(Math.floor(px), Math.floor(py), Math.floor(nextZ))) {
    nextZ = pz;
    vz = 0;
  }

  // --- Y collision (UP & DOWN FIXED) ---
  const nextYBlock = Math.floor(nextY);

  if (isBlock(Math.floor(px), nextYBlock, Math.floor(pz))) {
    if (vy < 0) {
      // Hitting ground
      nextY = nextYBlock + 1; // stand ON BLOCK
    } else {
      // Hitting ceiling
      nextY = nextYBlock - 0.001;
    }
    vy = 0;
  }

  return { x: nextX, y: nextY, z: nextZ, vx, vy, vz };
}

// -------------------------------------------
// MAIN LOOP
// -------------------------------------------
let last = performance.now();
function loop(t) {
  requestAnimationFrame(loop);

  const dt = (t - last) / 1000;
  last = t;

  // Gravity
  velY -= 20 * dt;

  // Speed
  const speed = 6;
  const sinY = Math.sin(yaw);
  const cosY = Math.cos(yaw);

  let moveX = 0, moveZ = 0;

  if (keys["KeyW"]) { moveX += -sinY; moveZ += -cosY; }
  if (keys["KeyS"]) { moveX -= -sinY; moveZ -= -cosY; }
  if (keys["KeyA"]) { moveX += -cosY; moveZ += sinY; }
  if (keys["KeyD"]) { moveX -= -cosY; moveZ -= sinY; }

  const len = Math.hypot(moveX, moveZ);
  if (len > 0) {
    moveX = (moveX / len) * speed * dt;
    moveZ = (moveZ / len) * speed * dt;
  }

  velX = moveX;
  velZ = moveZ;

  // Apply movement + fixed collision
  const res = collideAndSlide(camX, camY, camZ, velX, velY * dt, velZ);

  camX = res.x;
  camY = res.y;
  camZ = res.z;
  velY = res.vy;

  // Render (ORIGINAL — unchanged)
  gl.viewport(0, 0, canvas.width, canvas.height);
  gl.clearColor(0.02, 0.04, 0.07, 1);
  gl.clear(gl.COLOR_BUFFER_BIT);

  // Fake horizon line
  gl.enable(gl.SCISSOR_TEST);
  gl.scissor(0, canvas.height / 2, canvas.width, 2);
  gl.clearColor(0.3, 0.4, 0.5, 1);
  gl.clear(gl.COLOR_BUFFER_BIT);
  gl.disable(gl.SCISSOR_TEST);

  // FPS
  fps.textContent = (1/dt).toFixed(0) + " FPS";
}

loop();
</script>
</body>
</html>
