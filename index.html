// REPLACE your existing cameraRayDir with this corrected version
function cameraRayDir(pixelX, pixelY, canvasW=CANVAS_W, canvasH=CANVAS_H){
  // NDC coords: -1..1 (x right, y up)
  const nx = (pixelX - canvasW/2) / (canvasW/2);
  const ny = (canvasH/2 - pixelY) / (canvasH/2);
  const sx = Math.tan(FOV/2) * nx;
  const sy = Math.tan(FOV/2) * ny;

  // forward from spherical coords (yaw,pitch)
  const forward = { x: Math.cos(pitch)*Math.cos(yaw), y: Math.sin(pitch), z: Math.cos(pitch)*Math.sin(yaw) };

  // CORRECT: right = normalize(cross(forward, worldUp))
  const worldUp = { x: 0, y: 1, z: 0 };
  let right = cross(forward, worldUp);
  right = normalize(right);

  // up = right Ã— forward (forms a right-handed basis)
  let up = cross(right, forward);
  up = normalize(up);

  // combine to form ray direction
  let dir = {
    x: forward.x + right.x * sx + up.x * sy,
    y: forward.y + right.y * sx + up.y * sy,
    z: forward.z + right.z * sx + up.z * sy
  };
  const L = Math.hypot(dir.x, dir.y, dir.z) || 1;
  dir.x /= L; dir.y /= L; dir.z /= L;
  return dir;
}
